name: Demo Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type (patch/minor/major)'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  release-demo:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm install
        npm install --prefix client
        npm install --prefix api
    
    - name: Build application
      run: |
        npm run build --prefix client
    
    - name: Run tests
      run: |
        npm run test --prefix client
        npm run test --prefix api
    
    - name: Create demo release
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        node scripts/version-manager.js release-demo ${{ github.event.inputs.version_type || 'patch' }}
    
    - name: Build Docker image
      run: |
        docker build -t vtria-erp:demo-${{ github.ref_name }} .
        docker tag vtria-erp:demo-${{ github.ref_name }} vtria-erp:latest-demo
    
    - name: Validate Docker credentials
      id: docker_creds
      run: |
        if [ "${{ secrets.DOCKER_USERNAME }}" != "" ] && [ "${{ secrets.DOCKER_PASSWORD }}" != "" ] && [ "${{ secrets.DOCKER_REGISTRY }}" != "" ]; then
          echo "DOCKER_CREDS_VALID=true" >> $GITHUB_OUTPUT
          echo "::notice::Docker credentials are configured."
        else
          echo "DOCKER_CREDS_VALID=false" >> $GITHUB_OUTPUT
          echo "::notice::Docker credentials not fully configured. Skipping registry push."
        fi

    - name: Login to Docker Registry
      if: steps.docker_creds.outputs.DOCKER_CREDS_VALID == 'true'
      run: |
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login ${{ secrets.DOCKER_REGISTRY }} -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin || {
          echo "::error::Failed to login to Docker registry"
          exit 1
        }

    - name: Push to registry
      if: steps.docker_creds.outputs.DOCKER_CREDS_VALID == 'true'
      run: |
        IMAGE_TAG=demo-$(node -e "console.log(process.env.GITHUB_REF_NAME || 'latest')")
        docker tag vtria-erp:$IMAGE_TAG ${{ secrets.DOCKER_REGISTRY }}/vtria-erp:$IMAGE_TAG
        docker tag vtria-erp:latest-demo ${{ secrets.DOCKER_REGISTRY }}/vtria-erp:latest-demo
        
        docker push ${{ secrets.DOCKER_REGISTRY }}/vtria-erp:$IMAGE_TAG
        docker push ${{ secrets.DOCKER_REGISTRY }}/vtria-erp:latest-demo
    
    - name: Create deployment package
      run: |
        mkdir -p deployment/demo
        tar -czf deployment/demo/vtria-erp-demo-${{ github.ref_name }}.tar.gz \
          --exclude=node_modules \
          --exclude=.git \
          --exclude=deployment \
          .
    
    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: demo-release
        path: deployment/demo/
        retention-days: 30
    
    - name: Generate release info
      id: release_info
      if: always()
      run: |
        VERSION=$(node -e "try { console.log(require('./package.json').version) } catch (e) { console.error('âŒ Error reading version:', e.message); process.exit(1) }")
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        
        # Create release notes
        {
          echo "## ðŸŽ‰ Demo Release $VERSION"
          echo ""
          echo "### ðŸš€ Deployment Info"
          echo "- **Version:** $VERSION"
          echo "- **Branch:** main"
          echo "- **Commit:** ${{ github.sha }}"
          echo ""
          echo "### ðŸ”— Access"
          echo "- **Demo URL:** https://demo.vtria.com"
          echo "- **Health Check:** https://demo.vtria.com/health"
          echo ""
          echo "### ðŸ”’ Credentials"
          echo '- **Email:** demo@vtria.com'
          echo '- **Password:** Demo@123456'
          echo ""
          echo "### ðŸ“‹ Changelog"
          git log --pretty=format:"- %s" -n 5
        } > release-notes.md
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      if: success() && github.event_name == 'workflow_dispatch'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: demo-v${{ steps.release_info.outputs.VERSION }}
        name: "Demo Release v${{ steps.release_info.outputs.VERSION }}"
        body_path: release-notes.md
        draft: false
        prerelease: true
        files: |
          deployment/demo/*.tar.gz
        generate_release_notes: true
