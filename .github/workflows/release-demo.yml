name: Demo Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  release-demo:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm install
        npm install --prefix client
        npm install --prefix api
    
    - name: Build application
      run: |
        npm run build --prefix client
    
    - name: Run tests
      run: |
        npm run test --prefix client
        npm run test --prefix api
    
    - name: Create demo release
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        node scripts/version-manager.js release-demo ${{ github.event.inputs.version_type || 'patch' }}
    
    - name: Build Docker image
      run: |
        docker build -t vtria-erp:demo-${{ github.ref_name }} .
        docker tag vtria-erp:demo-${{ github.ref_name }} vtria-erp:latest-demo
    
    - name: Push to registry (if configured)
      if: env.DOCKER_REGISTRY != ''
      run: |
        echo ${{ secrets.DOCKER_PASSWORD }} | docker login ${{ secrets.DOCKER_REGISTRY }} -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
        docker push vtria-erp:demo-${{ github.ref_name }}
        docker push vtria-erp:latest-demo
      env:
        DOCKER_REGISTRY: ${{ secrets.DOCKER_REGISTRY }}
    
    - name: Create deployment package
      run: |
        mkdir -p deployment/demo
        tar -czf deployment/demo/vtria-erp-demo-${{ github.ref_name }}.tar.gz \
          --exclude=node_modules \
          --exclude=.git \
          --exclude=deployment \
          .
    
    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: demo-release
        path: deployment/demo/
        retention-days: 30
    
    - name: Notify team
      if: always()
      run: |
        echo "ðŸš€ Demo release completed successfully!"
        echo "Version: $(node -p "require('./package.json').version")"
        echo "Branch: main"
        echo "Commit: ${{ github.sha }}"
