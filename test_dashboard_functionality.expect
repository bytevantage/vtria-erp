#!/usr/bin/expect -f

set timeout 60
spawn ssh -p 65002 -o StrictHostKeyChecking=no u570718221@82.25.125.174

expect {
    "password:" {
        send "Ananyar@1\r"
        exp_continue
    }
    "$ " {
        send "cd /home/u570718221/domains/api.bytevantage.in/public_html/api\r"
        expect "$ "
        
        # Test dashboard page
        send "echo '=== TESTING DASHBOARD PAGE ==='\r"
        expect "$ "
        send "curl -s http://localhost:3001/dashboard | grep -E 'ByteVantage|License Management|Dashboard' | head -5\r"
        expect "$ "
        
        # Test admin licenses enhanced page (contains Edit Payment button)
        send "echo '=== TESTING ADMIN LICENSES ENHANCED PAGE ==='\r"
        expect "$ "
        send "curl -s 'http://localhost:3001/admin/licenses-enhanced' | grep -E 'Edit Payment|License Management' | head -5\r"
        expect "$ "
        
        # Test payment management page
        send "echo '=== TESTING PAYMENT MANAGEMENT PAGE ==='\r"
        expect "$ "
        send "curl -s 'http://localhost:3001/admin/payments' | grep -E 'Payment|Management|Enterprise' | head -5\r"
        expect "$ "
        
        # Test API endpoints
        send "echo '=== TESTING PAYMENTS API ENDPOINT ==='\r"
        expect "$ "
        send "curl -s -H 'Authorization: Bearer test-token' 'http://localhost:3001/api/admin/payments'\r"
        expect "$ "
        
        # Test health endpoint for stability
        send "echo '=== TESTING SERVER STABILITY ==='\r"
        expect "$ "
        send "curl -s http://localhost:3001/health\r"
        expect "$ "
        
        # Check if server is still running after all requests
        send "echo '=== FINAL SERVER STATUS CHECK ==='\r"
        expect "$ "
        send "ps aux | grep 'node server.js' | grep -v grep\r"
        expect "$ "
        
        send "echo 'Dashboard functionality test complete'\r"
        expect "$ "
        
        send "exit\r"
    }
    timeout {
        puts "Connection timed out"
        exit 1
    }
    eof
}